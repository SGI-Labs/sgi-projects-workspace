# Story 1.2: irix-build Remote Execution & Log Capture

## Status
Approved

## Story
**As a** macOS developer compiling IRIX demos remotely
**I want** the CLI to execute compiled binaries on the Octane and stream their output locally
**so that** I can verify runtime behavior and inspect system logs without logging in manually

## Acceptance Criteria
1. CLI provides a command (e.g., `irix-build run <target>`) that executes binaries under `~/src/irix_demo/bin` on host `octane` via the existing SSH configuration and streams stdout/stderr to the local console in real time.
2. CLI captures non-zero exit codes from remote executions and returns them locally, annotating which target failed and surfacing stderr content.
3. CLI offers an option (e.g., `--tail-syslog`) that, when supplied, tails `/var/adm/SYSLOG` during execution and prefixes each log line with timestamps and source labels.
4. CLI supports a dry-run flag that prints intended remote commands (execution and log tail) without running them, matching the sync/build dry-run behavior from Story 1.1.
5. Documentation and help output describe usage patterns, including combining run with build outputs, enabling log tailing, and interpreting errors.

## Tasks / Subtasks
- [ ] Extend argument parsing in `tools/irix_build/cli.py` to add `run` subcommand with flags for target selection, `--tail-syslog`, and `--dry-run` (AC: 1,3,4)
  - [ ] Load defaults from `BuildConfig` in `config.py`, reusing host/path settings established in Story 1.1 (AC: 1)
- [ ] Create `tools/irix_build/run.py` implementing remote execution using `tools/irix_build/ssh.py` to invoke `ssh` and stream stdout/stderr (AC: 1,2)
  - [ ] Propagate exit codes through exceptions or return objects so CLI exits with remote status and annotated messaging (AC: 2)
- [ ] Implement optional log tailing within `run.py`, spawning a secondary `ssh` session to `tail -f /var/adm/SYSLOG`, interleaving output with target execution and prefixing lines with `[syslog]` tags (AC: 3)
  - [ ] Handle permission or connectivity failures gracefully by emitting warnings while allowing primary execution to proceed (AC: 3)
- [ ] Honor `--dry-run` by printing the planned `ssh` commands instead of executing them, ensuring parity with Story 1.1 dry-run semantics (AC: 4)
- [ ] Update CLI help, README, and introduce `docs/user-guides/irix-build.md` documenting run command usage, log tailing, dry-run expectations, and error messaging (AC: 5)
- [ ] Add automated tests under `tests/irix_build/test_run.py` covering command construction, exit code propagation, dry-run output, and log tail orchestration (AC: 1-4)
  - [ ] Monkeypatch subprocess calls to simulate stdout/stderr streams and syslog tail behavior (AC: 1-4)
- [ ] Document manual validation steps in the Testing section: run `hello_irix` and `cpu_count` binaries, tail syslog, simulate a failing binary, and note any follow-up doc work in `projects/irix-automation/docs/architecture/future-work.md` (AC: 1-4)

## Dev Notes
### Dependencies & Previous Story Insights
- Depends on Story 1.1 delivering sync/build routines and shared configuration. Reuse the existing subprocess wrappers and configuration dataclasses to maintain consistency.

### Environment & Credentials
- Continue to rely on host alias `octane`, SSH key `~/.ssh/irix_rsa`, and legacy crypto settings defined in the host profile; remote commands must use non-interactive `ssh` invocations.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#authentication--host-profile]`

### Tech Stack & Module Structure
- CLI remains Python 3.11 using `argparse`, with subprocess management handled in dedicated modules.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#local-automation-macos]`
- Place new runtime files under `tools/irix_build/` and tests under `tests/irix_build/`. Export `run` helpers from `__init__.py` as needed.  
  `[Source: projects/irix-automation/docs/architecture/source-tree.md]`
- Follow SGI coding standards: type hints, logging via `logging`, custom `RemoteCommandError`, and 100-character line limits.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`

### Runtime Execution Expectations
- Manual baseline runs binaries with `ssh octane '~/src/irix_demo/bin/<target>'`; replicate this behavior in the CLI while adding automation conveniences.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`
- Syslog tail uses `ssh octane 'tail -f /var/adm/SYSLOG'`; ensure CLI sanitizes output and terminates the tail when the target process ends.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`

### Diagnostics & Error Handling
- Provide actionable messaging when authentication, permissions, or command failures occur, referencing common troubleshooting scenarios (legacy `scp`, permissions, crypto algorithms).  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`
- When log tailing is requested and fails, emit a clear warning but allow the main execution to continue where safe.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`

### Testing Requirements
- Automated tests must simulate remote command outputs, ensuring stdout/stderr streaming order remains intact and exit codes propagate.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`
- Manual tests: after building via Story 1.1 CLI, run `irix-build run hello_irix` and `irix-build run cpu_count --tail-syslog`, observing local output and log streaming; record follow-up doc work in `future-work.md`.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`

### Project Structure Notes
- Create `docs/user-guides/` directory if missing and add `irix-build.md` documentation once the run functionality ships; keep `future-work.md` updated until then.  
  `[Source: projects/irix-automation/docs/architecture/future-work.md]`

## Dev Notes Â· Testing
- Manual validation steps noted above should be captured in Testing once executed. Include guidance for inducing a failure (e.g., running a non-existent binary) to confirm error handling for exit codes and log tail fallbacks.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`

## Testing
- Pending developer implementation.

## Change Log
| Date       | Version | Description                                                       | Author |
|------------|---------|-------------------------------------------------------------------|--------|
| 2024-02-14 | 0.1     | Initial draft created by Scrum Master Bob                         | Bob    |
| 2024-02-14 | 0.2     | Retargeted references to current architecture shards post-archive | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

