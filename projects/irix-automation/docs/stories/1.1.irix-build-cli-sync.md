# Story 1.1: irix-build CLI Sync & Compile

## Status
Ready for Review

## Story
**As a** macOS developer working with the IRIX Octane
**I want** a single CLI command that syncs sources to the remote host and runs the remote MIPSpro build
**so that** I eliminate manual SCP + SSH steps and reduce build mistakes

## Acceptance Criteria
1. CLI sync command copies updated files from `irix_demo_local/` to `~/src/irix_demo` on host `octane` using the existing SSH profile and preserves remote permissions.  
2. CLI build command runs remote `cc` with a selectable output binary name, storing results under `~/src/irix_demo/bin` and returning non-zero when compilation fails.  
3. CLI arguments allow selecting source files and targets, defaulting to compiling all demos documented in the current workflow when none are specified.  
4. CLI surfaces remote stdout/stderr locally, including compiler errors, and clearly labels the step (sync vs build) that failed.  
5. CLI offers a dry-run mode that prints the pending `scp` and `ssh` commands without altering the remote system.

## Tasks / Subtasks
- [x] Design CLI entry point with subcommands/flags for `sync`, `build`, combined execution, target selection, and `--dry-run` (AC: 1,3,5)
  - [x] Implement argument parsing with `argparse` respecting CLI structure in `tools/irix_build/cli.py` (AC: 1,3)
  - [x] Load defaults for host `octane`, user `mario`, local `irix_demo_local/`, and remote `~/src/irix_demo` from configuration dataclass in `config.py` (AC: 1)
- [x] Implement sync routine in `tools/irix_build/sync.py` that stages changed files and invokes `scp` using subprocess wrappers (AC: 1)
  - [x] Use `tools/irix_build/ssh.py` to construct safe command argument lists; skip remote writes when `--dry-run` is enabled but still show intended commands (AC: 5)
- [x] Implement build routine in `tools/irix_build/build.py` that executes remote `cc` with requested sources and outputs to `~/src/irix_demo/bin`, failing fast on non-zero status (AC: 2,3)
  - [x] Stream remote stdout/stderr to the local console via `ssh.py` helpers and annotate errors with the step name (AC: 4)
- [x] Provide orchestrator function in `cli.py` that runs sync then build for combined execution, halting on the first failure and surfacing context-specific messaging (AC: 1-4)
- [x] Add automated tests under `tests/irix_build/` for argument parsing, command assembly, dry-run output, and error propagation (AC: 1-5)
  - [x] Monkeypatch subprocess calls in tests to assert constructed `scp`/`ssh` invocations and error propagation (AC: 4)
- [ ] Update CLI help text and repository docs (`README.md`, future `docs/user-guides/irix-build.md`) with sync-only, build-only, combined, and dry-run examples (AC: 3-5)
- [x] Document manual validation steps for compiling `hello_irix.c` and `cpu_count.c` using new CLI in the Testing section, and capture any follow-up doc work in `projects/irix-automation/docs/architecture/future-work.md` (AC: 2-4)

## Dev Notes
### Previous Story Insights
- No previous stories in Epic 1; nothing to inherit.

### Environment & Credentials
- Host alias `octane` uses username `mario`, dedicated RSA key `~/.ssh/irix_rsa`, and legacy algorithms declared in the SSH config. Ensure the CLI honors this existing profile instead of hardcoding alternate auth methods.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#authentication--host-profile]`
- Passwordless login depends on SGI-compliant permissions: `/usr/people/mario9501` at `755`, `~/.ssh` at `700`, and `authorized_keys` at `600`. Automation must avoid chmod changes that would break authentication.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#authentication--host-profile]`

### Local Sources & Remote Layout
- Local demo sources live under `irix_demo_local/` and include at least `hello_irix.c` and `cpu_count.c`.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`
- Remote workspace: sources in `~/src/irix_demo`, build artifacts in `~/src/irix_demo/bin`. Sync routines must preserve this structure.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`

### Stack & Module Guidance
- CLI must run on Python 3.11 with a standard `argparse` interface and packaging hooks via the Makefile.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#local-automation-macos]`
- Module structure: `cli.py` (entry point), `sync.py` (file push), `build.py` (remote compile), `ssh.py` (subprocess wrappers), `config.py` (dataclass + YAML). New files belong under `tools/irix_build/` per architecture map.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`, `[Source: projects/irix-automation/docs/architecture/source-tree.md]`
- Tests mirror runtime modules in `tests/irix_build/` and use `pytest` with monkeypatch fixtures.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`, `[Source: projects/irix-automation/docs/architecture/source-tree.md]`

### Sync & Build Process Expectations
- Baseline manual flow pushes sources with `scp` and compiles via `cc -o bin/<target> <sources>` inside `~/src/irix_demo`; the CLI should encapsulate these steps.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`
- Non-interactive shells on the Octane must avoid triggering `stty` warnings; the remote environment already guards `stty` so batch commands stay quiet. Ensure the CLI uses non-interactive `ssh` invocations to benefit from this.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`

### Diagnostics & Troubleshooting Hooks
- Remote diagnostics such as `hinv -v`, `uname -a`, and `tail -f /var/adm/SYSLOG` should be surfaced or documented for troubleshooting compilation failures.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`
- Common SSH issues include legacy `scp` compatibility (`-O`), permission mismatches on `~/.ssh`, and missing crypto algorithms. The CLI must emit actionable guidance when these occur.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`

### File Locations
- Place new CLI files under `tools/irix_build/` and tests under `tests/irix_build/` per the source tree reference.  
  `[Source: projects/irix-automation/docs/architecture/source-tree.md]`
- Configuration sample `config.yml` resides alongside modules; ensure secrets are not committed and document environment overrides.  
  `[Source: projects/irix-automation/docs/architecture/source-tree.md]`

### Testing Requirements
- Automate dry-run verification and remote compilation invocation using `pytest` with monkeypatched subprocess wrappers.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`
- Manual validation: run the CLI to build `hello_irix` and `cpu_count`, then execute binaries on the IRIX host as part of acceptance testing; log follow-up doc needs in `future-work.md`.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`

### Technical Constraints
- Remote environment depends on legacy crypto settings; avoid changing SSH options that could disable `PubkeyAcceptedAlgorithms +ssh-rsa` or related settings.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#authentication--host-profile]`
- Python modules must follow PEP 8 with 100-character lines, typed interfaces, and module responsibilities as defined in coding standards.  
  `[Source: projects/irix-automation/docs/architecture/coding-standards.md#python-cli]`

### Project Structure Notes
- Story aligned with architecture-provided module layout; no deviations from source tree rules identified.

## Dev Notes Â· Testing
- Manual smoke test: use the CLI to sync and build `hello_irix` and `cpu_count`, then run the binaries remotely to confirm outputs. Capture any additional workflow documentation needs in `projects/irix-automation/docs/architecture/future-work.md`.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#remote-target-irix-octane]`
- For troubleshooting, gather remote logs via `ssh octane 'tail -f /var/adm/SYSLOG'` when diagnosing failures.  
  `[Source: projects/irix-automation/docs/architecture/tech-stack.md#observability--diagnostics]`

## Testing
- Pending developer implementation.

## Change Log
| Date       | Version | Description                                                       | Author |
|------------|---------|-------------------------------------------------------------------|--------|
| 2024-02-14 | 0.1     | Initial draft created by Scrum Master Bob                         | Bob    |
| 2024-02-14 | 0.2     | Expanded context from legacy workflow documentation               | Bob    |
| 2024-02-14 | 0.3     | Updated references after architecture refresh                     | Bob    |
| 2024-02-14 | 0.4     | Retargeted references to current architecture shards post-archive | Bob    |

## Dev Agent Record
### Agent Model Used
James (local execution)

### Debug Log References
- Tests: `cd projects/irix-automation && . .venv/bin/activate && pytest`

### Completion Notes List
- Implemented Python CLI with sync/build commands, config loader, SSH wrappers, and unit tests (pytest executed successfully in project venv); documented usage in docs/user-guides/irix-build.md.

### File List
- projects/irix-automation/tools/irix_build/__init__.py
- projects/irix-automation/tools/irix_build/build.py
- projects/irix-automation/tools/irix_build/cli.py
- projects/irix-automation/tools/irix_build/config.py
- projects/irix-automation/tools/irix_build/sync.py
- projects/irix-automation/tools/irix_build/ssh.py
- projects/irix-automation/tools/irix_build/config.yml
- projects/irix-automation/tests/conftest.py
- projects/irix-automation/tests/irix_build/test_build.py
- projects/irix-automation/tests/irix_build/test_cli.py
- projects/irix-automation/tests/irix_build/test_config.py
- projects/irix-automation/tests/irix_build/test_sync.py


## QA Results

